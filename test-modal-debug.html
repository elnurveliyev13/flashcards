<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <title>Modal Debug Test</title>
  <style>
    :root{--bg:#0f172a;--fg:#e5e7eb;--muted:#9ca3af;--card:#111827;--btn:#1f2937;--ok:#22c55e;--mid:#3b82f6;--hard:#f59e0b}
    html, body{overflow-x:hidden;max-width:100vw;position:relative;margin:0;padding:0;font-family:system-ui,-apple-system,sans-serif}

    /* Debug panel - always visible at top */
    #debugPanel{
      position:fixed;
      top:0;
      left:0;
      right:0;
      background:rgba(0,0,0,0.95);
      color:#0f0;
      font-size:11px;
      padding:8px;
      z-index:99999;
      max-height:200px;
      overflow-y:auto;
      border-bottom:2px solid #0f0;
      font-family:monospace;
      line-height:1.3;
    }
    #debugPanel .section{margin-bottom:6px;border-bottom:1px solid #333;padding-bottom:4px}
    #debugPanel .label{color:#ff0;font-weight:bold}
    #debugPanel .value{color:#0f0}
    #debugPanel .history{color:#0ff;margin-top:4px}

    /* Visual indicators */
    #rightEdgeLine{
      position:fixed;
      top:0;
      right:0;
      width:3px;
      height:100vh;
      background:red;
      z-index:99998;
      pointer-events:none;
    }

    /* Main container */
    #mod_flashcards_container{
      background:var(--bg);
      color:var(--fg);
      overflow-x:hidden;
      width:100%;
      max-width:100vw;
      box-sizing:border-box;
      min-height:100vh;
      position:relative;
      padding-top:210px; /* Space for debug panel */
      outline:3px solid #0f0; /* Green border to see container bounds */
    }

    /* Modal styles - same as real app */
    .modal{
      position:absolute;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      z-index:9999;
      box-sizing:border-box;
    }
    .modal>.box{
      max-width:960px;
      width:100%;
      max-height:85vh;
      overflow:auto;
      background:#0b1220;
      border:1px solid #374151;
      border-radius:16px;
      padding:16px;
      box-sizing:border-box;
      margin:0 auto;
    }

    body.modal-open{
      overflow:hidden !important;
      width:100vw !important;
      max-width:100vw !important;
      position:relative !important;
      min-height:100vh !important;
    }
    body.modal-open html{
      overflow:hidden !important;
      width:100vw !important;
      max-width:100vw !important;
    }
    body.modal-open #mod_flashcards_container{
      margin-left:0 !important;
      margin-right:0 !important;
      width:100vw !important;
      max-width:100vw !important;
    }

    /* Test controls */
    .controls{
      padding:20px;
      background:#1a1a2e;
      margin:20px;
      border-radius:12px;
    }
    .controls button{
      padding:12px 20px;
      margin:6px;
      background:#3b82f6;
      color:#fff;
      border:none;
      border-radius:8px;
      font-size:14px;
      cursor:pointer;
      font-weight:600;
    }
    .controls button:active{background:#2563eb}
    .controls .strategy-btn{background:#6366f1;margin-top:10px;display:block;width:100%;text-align:left}
    .controls .strategy-btn.active{background:#22c55e}

    .content{
      padding:20px;
      color:#e5e7eb;
    }
    .content h2{color:#f8fafc;margin-top:30px}
    .content p{line-height:1.6;margin:10px 0}

    @media (max-width:620px){
      #mod_flashcards_container{
        width:100vw !important;
        max-width:100vw !important;
        margin-left:0 !important;
        margin-right:0 !important;
        padding-left:0 !important;
        padding-right:0 !important;
        overflow-x:hidden !important;
        box-sizing:border-box !important;
      }
      .modal{
        left:0 !important;
        right:0 !important;
        width:100vw !important;
        max-width:100vw !important;
        padding:8px !important;
        box-sizing:border-box !important;
        margin:0 !important;
      }
      .modal>.box{
        max-width:calc(100vw - 16px) !important;
        width:calc(100vw - 16px) !important;
        margin:0 auto !important;
        padding:12px !important;
        box-sizing:border-box !important;
      }
    }
  </style>
</head>
<body>
  <!-- Visual indicators -->
  <div id="rightEdgeLine"></div>

  <!-- Debug panel -->
  <div id="debugPanel">
    <div class="section">
      <span class="label">VIEWPORT:</span>
      <span class="value" id="dbgViewport">-</span>
    </div>
    <div class="section">
      <span class="label">BODY:</span>
      <span class="value" id="dbgBody">-</span>
    </div>
    <div class="section">
      <span class="label">CONTAINER:</span>
      <span class="value" id="dbgContainer">-</span>
    </div>
    <div class="section">
      <span class="label">BODY STYLES:</span>
      <span class="value" id="dbgBodyStyles">-</span>
    </div>
    <div class="history" id="dbgHistory">HISTORY: ---</div>
  </div>

  <!-- Main container -->
  <div id="mod_flashcards_container">
    <div class="controls">
      <h3 style="color:#f8fafc;margin:0 0 12px 0">Modal Debug Test</h3>
      <button id="btnOpen">ðŸ”´ OPEN POPUP</button>

      <div style="margin-top:20px;padding-top:20px;border-top:1px solid #374151">
        <div style="color:#9ca3af;font-size:13px;margin-bottom:8px">Test Different Strategies:</div>
        <button class="strategy-btn" data-strategy="1">Strategy 1: modal position:fixed (original)</button>
        <button class="strategy-btn" data-strategy="2">Strategy 2: modal position:absolute (current)</button>
        <button class="strategy-btn" data-strategy="3">Strategy 3: no body position</button>
        <button class="strategy-btn" data-strategy="4">Strategy 4: + transform translateZ(0)</button>
        <button class="strategy-btn" data-strategy="5">Strategy 5: body height:100vh</button>
      </div>
    </div>

    <div class="content">
      <h2>Test Content</h2>
      <p>This is test content to see if the page gets cropped when the modal opens.</p>
      <p>The green border shows the container bounds.</p>
      <p>The red line on the right edge shows if the page is cropped.</p>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
      <p>Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="testModal" class="modal">
    <div class="box">
      <h3 style="color:#f8fafc;margin:0 0 12px 0">Test Popup</h3>
      <p style="color:#9ca3af;margin:12px 0">This is a test popup. Watch the debug panel to see what happens to the layout.</p>
      <p style="color:#9ca3af;margin:12px 0">Check if the right edge line (red) is still visible.</p>
      <button id="btnClose" style="padding:10px 20px;background:#22c55e;color:#fff;border:none;border-radius:8px;margin-top:12px;cursor:pointer;font-weight:600">CLOSE POPUP</button>
    </div>
  </div>

  <script>
    // State tracking
    let currentStrategy = 2; // Default to current approach
    let history = [];

    // Elements
    const modal = document.getElementById('testModal');
    const btnOpen = document.getElementById('btnOpen');
    const btnClose = document.getElementById('btnClose');
    const container = document.getElementById('mod_flashcards_container');

    // Debug functions
    function getMetrics() {
      const html = document.documentElement;
      const body = document.body;
      const bodyStyles = window.getComputedStyle(body);

      return {
        viewport: {
          innerWidth: window.innerWidth,
          innerHeight: window.innerHeight,
          clientWidth: html.clientWidth,
          clientHeight: html.clientHeight,
          scrollWidth: html.scrollWidth,
          scrollHeight: html.scrollHeight
        },
        body: {
          clientWidth: body.clientWidth,
          scrollWidth: body.scrollWidth,
          offsetWidth: body.offsetWidth,
          clientHeight: body.clientHeight,
          scrollHeight: body.scrollHeight,
          offsetHeight: body.offsetHeight
        },
        container: {
          clientWidth: container.clientWidth,
          scrollWidth: container.scrollWidth,
          offsetWidth: container.offsetWidth,
          clientHeight: container.clientHeight,
          scrollHeight: container.scrollHeight
        },
        bodyStyles: {
          position: bodyStyles.position,
          width: bodyStyles.width,
          maxWidth: bodyStyles.maxWidth,
          overflow: bodyStyles.overflow,
          overflowX: bodyStyles.overflowX,
          transform: bodyStyles.transform
        }
      };
    }

    function updateDebugPanel() {
      const m = getMetrics();

      document.getElementById('dbgViewport').textContent =
        `inner:${m.viewport.innerWidth}x${m.viewport.innerHeight} | ` +
        `client:${m.viewport.clientWidth}x${m.viewport.clientHeight} | ` +
        `scroll:${m.viewport.scrollWidth}x${m.viewport.scrollHeight}`;

      document.getElementById('dbgBody').textContent =
        `client:${m.body.clientWidth} | scroll:${m.body.scrollWidth} | offset:${m.body.offsetWidth} | ` +
        `h:${m.body.clientHeight}/${m.body.scrollHeight}/${m.body.offsetHeight}`;

      document.getElementById('dbgContainer').textContent =
        `client:${m.container.clientWidth} | scroll:${m.container.scrollWidth} | offset:${m.container.offsetWidth}`;

      document.getElementById('dbgBodyStyles').textContent =
        `pos:${m.bodyStyles.position} | w:${m.bodyStyles.width} | max:${m.bodyStyles.maxWidth} | ` +
        `ovf:${m.bodyStyles.overflow}/${m.bodyStyles.overflowX} | tf:${m.bodyStyles.transform}`;

      return m;
    }

    function logHistory(event, metrics) {
      const entry = {
        time: new Date().toLocaleTimeString(),
        event: event,
        bodyWidth: metrics.body.clientWidth,
        containerWidth: metrics.container.clientWidth,
        viewportWidth: metrics.viewport.innerWidth,
        cropped: metrics.body.scrollWidth > metrics.body.clientWidth
      };

      history.push(entry);
      console.log(`[${event}]`, entry);

      // Update history display
      const historyText = history.map(h =>
        `${h.time} ${h.event}: vp=${h.viewportWidth} body=${h.bodyWidth} cont=${h.containerWidth} ${h.cropped ? 'âš ï¸CROPPED' : 'âœ“OK'}`
      ).join(' | ');
      document.getElementById('dbgHistory').textContent = 'HISTORY: ' + historyText;
    }

    // Apply strategy
    function applyStrategy(strategyNum) {
      currentStrategy = strategyNum;

      // Reset all
      document.body.classList.remove('modal-open');
      document.body.style.cssText = '';
      document.documentElement.style.cssText = '';
      container.style.cssText = '';
      modal.style.cssText = '';

      // Update button states
      document.querySelectorAll('.strategy-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.strategy == strategyNum);
      });

      console.log(`Applied strategy ${strategyNum}`);
    }

    // Open modal
    function openModal() {
      const beforeMetrics = updateDebugPanel();
      logHistory('BEFORE_OPEN', beforeMetrics);

      // Apply current strategy
      switch(currentStrategy) {
        case 1:
          // Original: position:fixed on modal
          modal.style.position = 'fixed';
          modal.style.top = '0';
          modal.style.left = '0';
          modal.style.right = '0';
          modal.style.bottom = '0';
          document.body.classList.add('modal-open');
          break;

        case 2:
          // Current: position:absolute on modal
          modal.style.position = 'absolute';
          document.body.classList.add('modal-open');
          break;

        case 3:
          // No position on body
          modal.style.position = 'absolute';
          document.body.style.overflow = 'hidden';
          document.body.style.width = '100vw';
          document.body.style.maxWidth = '100vw';
          // Don't set position:relative
          break;

        case 4:
          // With transform
          modal.style.position = 'absolute';
          document.body.classList.add('modal-open');
          document.body.style.transform = 'translateZ(0)';
          container.style.transform = 'translateZ(0)';
          break;

        case 5:
          // Explicit height
          modal.style.position = 'absolute';
          document.body.classList.add('modal-open');
          document.body.style.height = '100vh';
          break;
      }

      modal.style.display = 'flex';
      window.scrollTo(0, 0);

      setTimeout(() => {
        const afterMetrics = updateDebugPanel();
        logHistory('AFTER_OPEN', afterMetrics);
      }, 100);
    }

    // Close modal
    function closeModal() {
      const beforeMetrics = updateDebugPanel();
      logHistory('BEFORE_CLOSE', beforeMetrics);

      modal.style.display = 'none';
      document.body.classList.remove('modal-open');
      document.body.style.cssText = '';
      document.documentElement.style.cssText = '';
      container.style.cssText = '';
      modal.style.cssText = '';

      setTimeout(() => {
        const afterMetrics = updateDebugPanel();
        logHistory('AFTER_CLOSE', afterMetrics);
        window.scrollTo(0, 0);
      }, 100);
    }

    // Event listeners
    btnOpen.addEventListener('click', openModal);
    btnClose.addEventListener('click', closeModal);

    document.querySelectorAll('.strategy-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        applyStrategy(parseInt(btn.dataset.strategy));
      });
    });

    // Monitor resize
    const resizeObserver = new ResizeObserver(() => {
      updateDebugPanel();
    });
    resizeObserver.observe(document.body);
    resizeObserver.observe(container);

    // Monitor mutations
    const mutationObserver = new MutationObserver((mutations) => {
      mutations.forEach(mutation => {
        if (mutation.type === 'attributes' && (mutation.attributeName === 'class' || mutation.attributeName === 'style')) {
          console.log('Mutation detected:', mutation.target.tagName, mutation.attributeName);
          updateDebugPanel();
        }
      });
    });
    mutationObserver.observe(document.body, { attributes: true, attributeOldValue: true });
    mutationObserver.observe(document.documentElement, { attributes: true, attributeOldValue: true });

    // Initial update
    setTimeout(() => {
      const initialMetrics = updateDebugPanel();
      logHistory('INITIAL_LOAD', initialMetrics);
      applyStrategy(2); // Set default strategy
    }, 100);

    // Log initial device info
    console.log('Device:', navigator.userAgent);
    console.log('Screen:', screen.width, 'x', screen.height);
    console.log('Window:', window.innerWidth, 'x', window.innerHeight);
  </script>
</body>
</html>
