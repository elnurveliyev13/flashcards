Ниже — ТЗ по улучшению текущего решения.

1. Цель

Сделать из текущего «проверить одно предложение» сервиса полноценный чат с ИИ-корректором норвежского, который:

Проверяет текст пользователя и предлагает:

исправленный вариант;

более естественный/стилистически лучший вариант;

краткое объяснение ошибок.

Позволяет пользователю продолжать диалог с ИИ по поводу того же текста:

«Ты уверен?» (проверка уверенности/повторная валидация),

«Объясни ошибку»,

«Дай примеры»,

«Объясни проще» и т.д.

Использует диалоговую модель с историей сообщений (messages[]), а не отдельные независимые запросы.

2. Общая архитектура
2.1. Хранение диалогов

Для кажфдого пользователя/сессии хранить диалог:

type Role = 'system' | 'user' | 'assistant';

interface ChatMessage {
  id: string;             // внутренний ID сообщения
  role: Role;
  content: string;
  createdAt: Date;
}

interface ChatSession {
  id: string;
  userId: string;
  messages: ChatMessage[];
  // опционально: metadata: { ... }
}


Диалог сохраняется в БД (или in-memory + периодический сброс).

2.2. Формирование запроса к модели

При любом действии пользователя (ввод текста, нажатие кнопки):

Находим/создаём ChatSession.

Собираем массив messages[] для запроса к модели:

1–2 system-сообщения с ролью модели (корректор норвежского и т.п.).

N последних пар user/assistant сообщений (см. управление контекстом ниже).

Новое user-сообщение (либо текст пользователя, либо авто-шаблон от кнопки).

Отправляем messages[] в API модели.

Ответ модели (assistant) сохраняем в ChatSession.messages.

3. Поток для проверки текста (основной сценарий)
3.1. Первый запрос: пользователь вводит норвежский текст
UI

Пользователь вводит текст (например: han sier det er ikke nødvendig å lære norsk).

Нажимает кнопку «Проверить».

Backend

Создаём новую сессию (ChatSession) или находим существующую.

Формируем messages[]:

[
  {
    "role": "system",
    "content": "Ти — уважний коректор норвезького тексту для студентів. Твоя задача — лише перевіряти норвезькі речення, виправляти помилки та пояснювати їх українською максимально чітко й нейтрально."
  },
  {
    "role": "user",
    "content": "Будь ласка, перевір наступний текст норвезькою на помилки.\n\nТекст користувача:\n\"han sier det er ikke nødvendig å lære norsk\"\n\n1. Запропонуй виправлений варіант.\n2. Якщо можливо, запропонуй більш природній варіант.\n3. Коротко поясни основні помилки українською.\n4. Відповідай українською."
  }
]


Отправляем в модель.

Полученный ответ сохраняем как assistant-сообщение в ChatSession.messages.

Отдаём на UI:

исправленный текст,

более естественный текст,

объяснение,

а также UI-кнопки:

«Ти впевнений?»,

«Поясни детальніше»,

«Дай більше прикладів»,

«Поясни простіше».

4. Поведение кнопок (авто-промпты)

Все кнопки работают по варианту A: они не создают отдельный независимый запрос, а добавляют новое user-сообщение в текущий диалог и отправляют всю (или часть) истории.

4.1. Кнопка «Ти впевнений?»
Backend

В текущую ChatSession добавляется сообщение:

{
  "role": "user",
  "content": "Будь ласка, ще раз перевір свої попередні виправлення. Наскільки ти впевнена, що виправлений текст і більш природний варіант є правильними?\n\nОпиши рівень впевненості й коротко поясни чому. Якщо бачиш можливу іншу коректну альтернативу — також наведи її. Відповідай українською."
}


Собираем messages[]:

system + несколько последних сообщений (см. раздел 5),

плюс это новое user-сообщение.

Отправляем в модель, сохраняем ответ как assistant.

4.2. Кнопка «Поясни детальніше»
{
  "role": "user",
  "content": "Поясни, будь ласка, детальніше, чому саме так треба будувати речення в твоєму виправленому варіанті. Можеш коротко використовувати граматичну термінологію. Відповідай українською."
}


Модель должна, опираясь на предыдущие ответы, развернуть объяснение.

4.3. Кнопка «Дай більше прикладів»
{
  "role": "user",
  "content": "Створи, будь ласка, 5–10 коротких норвезьких речень з такою ж граматичною структурою, як у виправленому варіанті. До кожного речення додай переклад українською."
}

4.4. Кнопка «Поясни простіше»
{
  "role": "user",
  "content": "Поясни цю помилку максимально просто, без граматичної термінології, щоб це було зрозуміло початківцю. Відповідай українською."
}

5. Управление контекстом (history & truncation)

У моделей есть ограничение по длине контекста, поэтому нужно:

Хранить полную историю в БД.

При каждом запросе формировать messagesForModel[]:

всегда включать:

1–2 system сообщения (роль модели, язык объяснений),

последние K сообщений (например, 6–10 штук: 3–5 последних пар user/assistant).

Если диалог очень длинный:

удалённые части истории либо:

игнорировать при отправке,

либо предварительно сжимать в краткое резюме и вставлять одним assistant-сообщением:

{
  "role": "assistant",
  "content": "Коротке резюме попередньої розмови: ... (1–3 речення)"
}


Нужна конфигурация:

const MAX_MESSAGES_PER_REQUEST = 10; // или конфиг

6. Требования к промптам (стиль и стабильность)

Язык объяснений: украинский (как в текущем решении) — зашить в system + повторять в конкретных запросах, если нужно.

Модель всегда должна:

сначала показать исправленный норвежский текст,

затем «более естественный/стилистический» вариант (если уместно),

затем краткое объяснение.

В кнопках важно не дублировать лишнюю информацию (оригинальный текст, исправления) — модель их уже видит в предыдущих сообщениях.

7. API-пример (абстрактно, в стиле OpenAI)
async function callModel(session: ChatSession): Promise<string> {
  const messagesForModel = buildMessagesForModel(session);

  const response = await openai.chat.completions.create({
    model: 'gpt-4.x', // или нужная модель
    messages: messagesForModel,
    temperature: 0.2
  });

  const assistantMessage = response.choices[0].message.content;
  // сохранить assistantMessage в session.messages и БД
  return assistantMessage;
}


buildMessagesForModel(session):

function buildMessagesForModel(session: ChatSession): ChatMessage[] {
  const systemMessages: ChatMessage[] = [
    {
      id: 'sys1',
      role: 'system',
      content: 'Ти — уважний коректор норвезького тексту... (основні правила)'
    }
  ];

  const history = takeLastN(session.messages, MAX_MESSAGES_PER_REQUEST);

  return [...systemMessages, ...history];
}

8. Поведение на UI

После первого ответа ИИ отображать:

блок «Виправлений текст»,

блок «Більш природний варіант»,

блок «Пояснення»,

блок кнопок:
«Ти впевнений?» | «Поясни детальніше» | «Дай більше прикладів» | «Поясни простіше».

При нажатии кнопки:

UI отправляет запрос /chat/:sessionId/action с типом действия (confidence, explain_more, more_examples, simplify).

Backend подставляет соответствующий текст user-сообщения и вызывает модель по схеме выше.

Ответ отображается в виде нового сообщения от ИИ в чате под предыдущими.

9. Совместимость с текущим решением

Текущий подход, где ты отправляешь заранее сформированный текст вида
Original text: ..., Corrected text: ..., More natural alternative: ...,
можно оставить как отдельный эндпоинт (например, batch-проверка) или как fallback.

Для интерактивного режима «чат + кнопки» основным становится диалоговый формат с историей (вариант A).